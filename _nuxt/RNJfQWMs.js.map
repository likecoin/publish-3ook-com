{"version":3,"file":"RNJfQWMs.js","sources":["../../../stores/orders.ts"],"sourcesContent":["import type { OrderData, BookListingItem } from '~/utils/api'\n\nexport interface ReaderData {\n  readerEmail: string\n  readerWallet?: string\n  firstPurchaseTime: string\n  lastPurchaseTime: string\n  lifetimeValue: number\n  hasMessage: boolean\n  purchasedBooks: Record<string, boolean>\n  [key: string]: string | number | boolean | Record<string, boolean> | undefined\n}\n\nexport interface BookInfo {\n  name: string\n  classId: string\n}\n\nexport const useOrdersStore = defineStore('orders', () => {\n  const bookstoreApiStore = useBookstoreApiStore()\n  const { token, isAuthenticated } = storeToRefs(bookstoreApiStore)\n\n  const booksInfo = ref<Record<string, BookInfo>>({})\n  const allOrders = ref<(OrderData & { classId: string })[]>([])\n  const isLoading = ref(false)\n  const error = ref('')\n\n  watch(isAuthenticated, () => {\n    if (isAuthenticated.value) {\n      lazyFetchReaders()\n    } else {\n      clearCache()\n    }\n  })\n\n  const ordersByClassIdMap = computed(() => {\n    // eslint-disable-next-line func-call-spacing\n    const map = new Map<string, (OrderData & { classId: string })[]>()\n    allOrders.value.forEach((order) => {\n      const classId = order.classId\n      if (!map.has(classId)) {\n        map.set(classId, [])\n      }\n      map.get(classId)!.push(order)\n    })\n    return map\n  })\n\n  const readers = computed(() => {\n    const uniqueClassIds = Object.keys(booksInfo.value)\n    if (uniqueClassIds.length === 0 || allOrders.value.length === 0) {\n      return []\n    }\n\n    const readersMap = new Map<string, ReaderData>()\n\n    allOrders.value.forEach((order) => {\n      const readerEmail = order.email\n      if (!readerEmail) { return }\n\n      const purchaseTime = new Date(order.timestamp).toISOString()\n      const amount = order.price || 0\n      const hasMessage = !!(order.message && order.message.trim())\n      const wallet = order.wallet\n\n      if (readersMap.has(readerEmail)) {\n        const existing = readersMap.get(readerEmail)\n        if (!existing) { return }\n\n        if (new Date(purchaseTime) < new Date(existing.firstPurchaseTime)) {\n          existing.firstPurchaseTime = purchaseTime\n        }\n        if (new Date(purchaseTime) > new Date(existing.lastPurchaseTime)) {\n          existing.lastPurchaseTime = purchaseTime\n        }\n\n        existing.lifetimeValue += amount\n\n        if (hasMessage) {\n          existing.hasMessage = true\n        }\n\n        existing.purchasedBooks[order.classId] = true\n\n        if (wallet && !existing.readerWallet) {\n          existing.readerWallet = wallet\n        }\n      } else {\n        const purchasedBooks: Record<string, boolean> = {}\n        uniqueClassIds.forEach((classId) => {\n          purchasedBooks[classId] = false\n        })\n        purchasedBooks[order.classId] = true\n\n        readersMap.set(readerEmail, {\n          readerEmail,\n          readerWallet: wallet,\n          firstPurchaseTime: purchaseTime,\n          lastPurchaseTime: purchaseTime,\n          lifetimeValue: amount,\n          hasMessage,\n          purchasedBooks\n        })\n      }\n    })\n\n    return Array.from(readersMap.values()).map((reader) => {\n      const bookSortFields: Record<string, number> = {}\n      uniqueClassIds.forEach((classId) => {\n        bookSortFields[`book_${classId}`] = reader.purchasedBooks[classId] ? 1 : 0\n      })\n\n      return {\n        ...reader,\n        ...bookSortFields\n      }\n    })\n  })\n\n  async function fetchOrdersByClassId (classIds: string[]) {\n    const orders: (OrderData & { classId: string })[] = []\n\n    for (const classId of classIds) {\n      try {\n        const ordersData = await fetchBookOrders(classId, token.value)\n        const classOrders = ordersData?.orders || []\n        if (classOrders.length > 0) {\n          orders.push(...classOrders.map(order => ({ ...order, classId })))\n        }\n      } catch (err) {\n        console.error(`Failed to fetch orders for classId ${classId}:`, err)\n      }\n    }\n\n    allOrders.value = orders\n    return orders\n  }\n\n  async function lazyFetchOrdersByClassId (classIds: string[], force = false) {\n    if (!force && allOrders.value.length > 0) {\n      const fetchedClassIds = new Set(allOrders.value.map(order => order.classId))\n      const hasAllClassIds = classIds.every(id => fetchedClassIds.has(id))\n      if (hasAllClassIds) {\n        return allOrders.value\n      }\n    }\n    return await fetchOrdersByClassId(classIds)\n  }\n\n  async function fetchReaders (force = false) {\n    if (!force && readers.value.length > 0) {\n      return\n    }\n\n    try {\n      isLoading.value = true\n      error.value = ''\n\n      await bookstoreApiStore.fetchBookListing()\n      await bookstoreApiStore.fetchModeratedBookList()\n\n      const allClassIds = [\n        ...bookstoreApiStore.listingList.map((book: BookListingItem) => book.classId),\n        ...bookstoreApiStore.moderatedBookList.map((book: BookListingItem) => book.classId)\n      ]\n\n      const uniqueClassIds = [...new Set(allClassIds)]\n\n      if (uniqueClassIds.length === 0) {\n        booksInfo.value = {}\n        return\n      }\n\n      const tempBooksInfo: Record<string, BookInfo> = {}\n\n      bookstoreApiStore.listingList.forEach((book: BookListingItem) => {\n        if (uniqueClassIds.includes(book.classId)) {\n          tempBooksInfo[book.classId] = {\n            name: book.name || book.classId,\n            classId: book.classId\n          }\n        }\n      })\n\n      bookstoreApiStore.moderatedBookList.forEach((book) => {\n        if (uniqueClassIds.includes(book.classId)) {\n          tempBooksInfo[book.classId] = {\n            name: book.name || book.classId,\n            classId: book.classId\n          }\n        }\n      })\n\n      booksInfo.value = tempBooksInfo\n\n      await lazyFetchOrdersByClassId(uniqueClassIds, force)\n    } catch (err) {\n      error.value = (err as Error).message || 'Failed to load readers data'\n      throw err\n    } finally {\n      isLoading.value = false\n    }\n  }\n\n  async function lazyFetchReaders () {\n    if (readers.value.length > 0) {\n      return readers.value\n    }\n    await fetchReaders()\n    return readers.value\n  }\n\n  function clearError () {\n    error.value = ''\n  }\n\n  function clearCache () {\n    allOrders.value = []\n    booksInfo.value = {}\n  }\n\n  return {\n    readers,\n    booksInfo: readonly(booksInfo),\n    allOrders: readonly(allOrders),\n    ordersByClassIdMap: readonly(ordersByClassIdMap),\n    isLoading: readonly(isLoading),\n    error: readonly(error),\n\n    fetchReaders,\n    lazyFetchReaders,\n    fetchOrdersByClassId,\n    lazyFetchOrdersByClassId,\n    clearError,\n    clearCache\n  }\n})\n"],"names":["useOrdersStore","defineStore","bookstoreApiStore","useBookstoreApiStore","token","isAuthenticated","storeToRefs","booksInfo","ref","allOrders","isLoading","error","watch","lazyFetchReaders","clearCache","ordersByClassIdMap","computed","map","order","classId","readers","uniqueClassIds","readersMap","readerEmail","purchaseTime","amount","hasMessage","wallet","existing","purchasedBooks","reader","bookSortFields","fetchOrdersByClassId","classIds","orders","classOrders","fetchBookOrders","err","lazyFetchOrdersByClassId","force","fetchedClassIds","id","fetchReaders","allClassIds","book","tempBooksInfo","clearError","readonly"],"mappings":"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"}