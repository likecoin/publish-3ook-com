import{_ as Be,C as N,m as d,L as t,t as Ee,c as h,g as Me,Q as Ue,a as te,u as qe,s as ae,b as Le,B as Ae,R as Ve,e as _,w as ne,o as Oe,l as k,n as m,W as p,p as y,M as l,q as e,X as Pe,ao as We,N as se,Y as De,ab as je,b0 as oe,$ as le,ai as re,aa as ze,ad as Qe,a0 as He,an as Ke,a1 as Ye,a9 as Ge,ac as Xe,a6 as Je,S as Ze}from"./9S2XGRg9.js";import{_ as et}from"./Bu69eulW.js";import{_ as tt}from"./4vuI4WC3.js";import{_ as at}from"./CLuOJMie.js";import{u as ie,a as nt}from"./CSf5BCM0.js";import{u as st}from"./DJApvAF_.js";import{a as ot,u as lt}from"./CFNaZjOu.js";import{u as rt}from"./Do2UJywV.js";(function(){try{var i=typeof window<"u"?window:typeof global<"u"?global:typeof globalThis<"u"?globalThis:typeof self<"u"?self:{};i.SENTRY_RELEASE={id:"cd189bad150b481aa5ecb2e95de26ec677010e55"}}catch{}})();try{(function(){var i=typeof window<"u"?window:typeof global<"u"?global:typeof globalThis<"u"?globalThis:typeof self<"u"?self:{},s=new i.Error().stack;s&&(i._sentryDebugIds=i._sentryDebugIds||{},i._sentryDebugIds[s]="21ae82b9-a96d-4440-b41a-1271a50d19e3",i._sentryDebugIdIdentifier="sentry-dbid-21ae82b9-a96d-4440-b41a-1271a50d19e3")})()}catch{}const it={},ut={class:"relative overflow-hidden rounded border border-dashed border-gray-400 dark:border-gray-500 opacity-75 flex items-center justify-center p-4"};function ct(i,s){return d(),N("div",ut,[s[0]||(s[0]=t("svg",{class:"absolute inset-0 h-full w-full stroke-gray-900/10 dark:stroke-white/10",fill:"none"},[t("defs",null,[t("pattern",{id:"placeholder-pattern",x:"0",y:"0",width:"10",height:"10",patternUnits:"userSpaceOnUse"},[t("path",{d:"M-3 13 15-5M-5 5l18-18M-1 21 17 3"})])]),t("rect",{stroke:"none",fill:"url(#placeholder-pattern)",width:"100%",height:"100%"})],-1)),Ee(i.$slots,"default")])}const dt=Object.assign(Be(it,[["render",ct]]),{__name:"PlaceholderCard"});function ft(i){return i.charCodeAt(0)>255}function _t(i,s){const E=h(()=>{const b=i.value||"";let T=0;for(let S=0;S<b.length;S++){const M=b[S];M&&(T+=ft(M)?2:1)}return T}),O=h(()=>E.value>s);return{messageCharCount:E,isLimitReached:O}}const mt={class:"text-lg font-bold font-mono"},pt={class:"divide-y w-full"},vt={class:"text-left px-4 py-3"},yt={class:"px-4 py-3"},ht={key:0},bt={class:"text-left px-4 py-3"},gt={class:"px-4 py-3"},wt={class:"text-left px-4 py-3"},xt={class:"px-4 py-3"},kt={class:"px-4 py-3"},It={class:"text-left px-4 py-3"},Ct={class:"px-4 py-3"},$t={class:"px-4 py-3"},Nt={class:"px-4 py-3"},Tt={class:"px-4 py-3"},St={class:"space-y-2 mb-4"},Ft=["textContent"],Rt=["textContent"],Bt={class:"flex flex-wrap items-center justify-center gap-2 w-full"},Et={class:"text-sm text-gray-400 dark:text-gray-600"},Mt=["textContent"],Ut=["textContent"],qt=["src"],zt=Me({__name:"[classId]",setup(i){const{t:s}=Ue(),{LIKE_CO_API:E}=te().public,O=qe(),{wallet:b,signer:T}=ae(O),{validateWalletConsistency:S}=O,M=Le(),{token:z,wallet:Q}=ae(M),H=st(),{lazyFetchClassMetadataById:ue}=H,P=Ae(),ce=Ve(),{writeContractAsync:de}=ot(),{getBalanceOf:fe,getTokenIdByOwnerIndex:_e}=ie(),{assertSufficientBalanceForTransaction:me,waitForTransactionReceipt:pe}=lt(),{showErrorToast:W}=rt(),g=_({message:"",actions:[]}),I=_(!1),r=h(()=>P.params.classId),K=h(()=>P.query.payment_id),U=h(()=>P.query.owner_wallet||Q.value),q=_(s("nft_book_form.default_memo")),{messageCharCount:ve,isLimitReached:Y}=_t(q,oe),{getNFTMetadata:ye,getNFTOwner:G}=ie(),F=_([]),u=_([]),L=_(!1),w=_(""),R=_(!1),he=_(void 0),o=_({}),A=_(""),V=_(!1),x=_(""),{NFT_ITEM_URL:be}=te().public,X=h(()=>F.value.some(a=>a.trim()!=="")),J=h(()=>I.value||L.value||!!w.value||Y.value||!R.value),B=h(()=>o.value.quantity===1),ge=h(()=>H.getClassMetadataById(r.value)?.name);ne(I,a=>{a&&(g.value={message:"",actions:[]})}),ne(F,(a,n)=>{n&&n.length>0&&B.value&&(R.value=!1,x.value="",w.value="")},{deep:!0}),Oe(async()=>{const a=await $fetch(`${E}/likernft/book/purchase/${r.value}/status/${K.value}`,{headers:{authorization:`Bearer ${z.value}`}});o.value=a,ue(r.value),await D(o.value.quantity||1)});async function we(){if(X.value)try{if(x.value="",w.value="",u.value=F.value.filter(f=>f.trim()!=="").map(f=>Number(f)),u.value.includes(0)){x.value=s("error.nft_id_reserved_for_author"),u.value=[];return}const a=u.value[0];if(!a){x.value=s("error.invalid_nft_id");return}const[n,c]=await Promise.all([Z(),G(r.value,a)]);if(!n||c!==Q.value){x.value=s("error.fetch_nft_metadata_failed"),u.value=[];return}R.value=!0}catch(a){x.value=a.message,u.value=[],R.value=!1}}async function Z(){try{if(L.value=!0,!u.value.length||u.value[0]===void 0){A.value="";return}try{const a=await ye(r.value,u.value[0]);return A.value=Je(a?.image||""),a}catch(a){A.value="",a?.data?.code===2?w.value="NFT not found":w.value=a.toString()}}catch(a){g.value={message:a.toString(),actions:[]},W(a.toString())}finally{L.value=!1}}async function D(a=1){try{if(u.value=[],w.value="",(!b.value||!T.value)&&await S(),!U.value)throw new Error("Missing owner wallet");const n=await fe(r.value,U.value);if(n<BigInt(a))throw new Error(`No NFTs available for classId: ${r.value} in wallet: ${U.value}`);const c=[];for(let C=0;C<Number(n);C++){const f=await _e(r.value,U.value,C);if(f!==0n&&(c.push(Number(f)),c.length>=a))break}if(c.length<a)throw new Error(`Failed to collect enough available NFTs. Collected ${c.length}/${a}`);u.value=c,F.value=c.map(String),R.value=!0,await Z()}catch(n){const c=n.toString();w.value=c,g.value={message:c,actions:[{label:s("button.restock_nft"),variant:"outline",color:"error",click:()=>{V.value=!0}}]},W(c)}}function xe(){window.open(`${be}/${r.value}`,"_blank","noopener")}async function ke(){if(!J.value)try{if(I.value=!0,(!b.value||!T.value)&&await S(),!b.value||!T.value)return;if(u.value){const f=(await Promise.all(u.value.map($=>G(r.value,$)))).findIndex($=>$!==U.value);if(f>=0){const $=u.value[f];throw new Error(`NFT classId: ${r.value} nftId:${$} is not owned by sender!`)}}else await D(o.value.quantity||1);const a={address:r.value,abi:nt,functionName:"batchTransferWithMemo",args:[b.value,Array(o.value.quantity).fill(o.value.wallet),u.value,Array(o.value.quantity).fill(q.value)]};await me({wallet:b.value,...a});const n=await de(a);(await pe({hash:n}))?.status==="success"&&(await $fetch(`${E}/likernft/book/purchase/${r.value}/sent/${K.value}`,{method:"POST",body:{txHash:n,quantity:o.value.quantity||1},headers:{authorization:`Bearer ${z.value}`}}),await Ze(ce({name:"my-books-status-classId",params:{classId:r.value}})))}catch(a){console.error(a),g.value={message:a.toString(),actions:[]},W(a.toString())}finally{I.value=!1}}function Ie(){V.value=!1,D(o.value.quantity||1)}return(a,n)=>{const c=Pe,C=We,f=De,$=et,ee=je,Ce=He,j=Ye,$e=Ge,Ne=dt,Te=tt,Se=Xe,Fe=at;return d(),k(Fe,null,{default:m(()=>[t("h1",mt,' Deliver NFT Book "'+l(e(ge)||e(r))+'" ',1),e(g).message?(d(),k(c,{key:0,icon:"i-heroicons-exclamation-triangle",color:"error",variant:"soft",title:`${e(g).message}`,actions:e(g).actions,close:{icon:"i-heroicons-x-mark-20-solid",color:"error",variant:"link"},onClose:n[0]||(n[0]=v=>g.value={message:"",actions:[]})},null,8,["title","actions"])):p("",!0),e(I)?(d(),k(C,{key:1,animation:"carousel"},{indicator:m(()=>[...n[3]||(n[3]=[se(" Loading... ",-1)])]),_:1})):p("",!0),e(M).isAuthenticated?(d(),k(f,{key:2,ui:{body:"space-y-6",footer:"flex justify-center gap-2"}},{footer:m(()=>[y(j,{label:e(s)("nft_send.sign_and_send"),disabled:e(J),size:"xl",onClick:ke},null,8,["label","disabled"])]),default:m(()=>[y(f,{ui:{body:"p-0"}},{default:m(()=>[t("table",pt,[t("tbody",null,[t("tr",null,[t("th",vt,l(e(s)("table.buyer_email")),1),t("td",yt,l(e(o).email),1)]),e(o).giftInfo?.toEmail?(d(),N("tr",ht,[t("th",bt,l(e(s)("table.reader_email")),1),t("td",gt,l(e(o).giftInfo?.toEmail||e(o).email),1)])):p("",!0),t("tr",null,[t("th",wt,l(e(s)("table.status")),1),t("td",xt,l(e(o).status),1)]),t("tr",null,[n[4]||(n[4]=t("th",{class:"text-left px-4 py-3"}," Buyer Wallet ",-1)),t("td",kt,l(e(o).wallet),1)]),t("tr",null,[t("th",It,l(e(s)("table.price_name")),1),t("td",Ct,l(e(o).priceName),1)]),t("tr",null,[n[5]||(n[5]=t("th",{class:"text-left px-4 py-3"}," Price ",-1)),t("td",$t,l(e(o).price),1)]),t("tr",null,[n[6]||(n[6]=t("th",{class:"text-left px-4 py-3"}," Quantity ",-1)),t("td",Nt,l(e(o).quantity),1)]),t("tr",null,[n[7]||(n[7]=t("th",{class:"text-left px-4 py-3"}," Sales channel ",-1)),t("td",Tt,l(e(o).from),1)])])])]),_:1}),y(f,null,{default:m(()=>[t("div",St,[t("h5",{class:"text-sm font-bold",textContent:l(`${e(s)("nft_book_form.buyer_message")}`)},null,8,Ft),t("p",{textContent:l(e(o).message)},null,8,Rt)]),y(ee,{label:e(s)("nft_book_form.author_message"),error:e(Y),hint:`${e(ve)} / ${e(oe)}`},{default:m(()=>[y($,{modelValue:e(q),"onUpdate:modelValue":n[1]||(n[1]=v=>le(q)?q.value=v:null)},null,8,["modelValue"])]),_:1},8,["label","error","hint"])]),_:1}),y(ee,{label:e(s)("form.nft_id_label"),class:"mb-4",error:e(w),ui:{description:"text-gray-400 dark:text-gray-600"}},{default:m(()=>[t("div",Bt,[e(o).quantity?(d(),N("div",{key:0,class:re([e(o).quantity>1?"w-full":"grow","space-y-1","relative"])},[(d(!0),N(ze,null,Qe(e(o).quantity,v=>(d(),k(Ce,{key:`nft-id-input-${v}`,ref_for:!0,ref_key:"nftIdInputRef",ref:he,modelValue:e(F)[v-1],"onUpdate:modelValue":Re=>e(F)[v-1]=Re,disabled:!e(B),class:"font-mono"},Ke({_:2},[e(o).quantity>1?{name:"leading",fn:m(()=>[t("span",Et,"#"+l(v),1)]),key:"0"}:void 0]),1032,["modelValue","onUpdate:modelValue","disabled"]))),128)),e(x)?(d(),N("span",{key:0,class:"text-xs text-red-500 absolute",textContent:l(e(x))},null,8,Mt)):e(R)&&e(B)?(d(),N("span",{key:1,class:"text-xs text-green-500 absolute",textContent:l(e(s)("button.confirmed"))},null,8,Ut)):p("",!0)],2)):p("",!0),e(B)?(d(),k(j,{key:1,label:e(s)("button.confirm_nft_id"),disabled:e(I)||e(L)||!e(X),variant:"outline",loading:e(L),color:"primary",onClick:we},null,8,["label","disabled","loading"])):p("",!0),e(B)?(d(),k($e,{key:2,class:re(["text-sm text-gray-600","sm:w-min"])},{default:m(()=>[...n[8]||(n[8]=[se(" OR ",-1)])]),_:1})):p("",!0),e(B)?(d(),k(j,{key:3,label:e(s)("button.check_all_nft_ids"),disabled:e(I),variant:"outline",onClick:xe},null,8,["label","disabled"])):p("",!0)])]),_:1},8,["label","error"]),y(Ne,{class:"h-[300px]"},{default:m(()=>[e(A)?(d(),N("img",{key:0,class:"max-w-[180px] w-full h-full object-contain",alt:"preview",src:e(A)},null,8,qt)):p("",!0)]),_:1})]),_:1})):p("",!0),y(Se,{open:e(V),"onUpdate:open":n[2]||(n[2]=v=>le(V)?V.value=v:null)},{content:m(()=>[y(Te,{"is-restock":!0,"iscn-id":e(r),onSubmit:Ie},null,8,["iscn-id"])]),_:1},8,["open"])]),_:1})}}});export{zt as default};
