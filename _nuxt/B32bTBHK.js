import{g as W,u as Q,s as X,w as z,o as Z,e as n,c2 as ce,C as x,m as b,p as y,$ as ue,q as l,n as O,L as g,aq as de,N as pe,M as j,ao as fe,ac as me,c as k,_ as _e,Q as ee,V as te,l as P,W as G,X as ve,B as be,R as ge,c3 as ye,S as q,y as J,aa as he,ad as we,aA as Fe,ai as Ne,a1 as Se,c4 as Ie,c5 as Te}from"./9S2XGRg9.js";import{u as xe,_ as ke,a as Ce}from"./DlXEXVN8.js";import{u as Re}from"./DQMAjF9Q.js";import{u as H}from"./Do2UJywV.js";import{v as Me}from"./2HupUEEh.js";import{_ as $e}from"./4vuI4WC3.js";import{u as Ue}from"./CSf5BCM0.js";import{_ as De}from"./CZMoFnbU.js";import{_ as Be}from"./CLuOJMie.js";import"./Bu69eulW.js";import"./D3om2a5D.js";import"./D2HD6JMx.js";import"./D89E3aNf.js";import"./DvvTWQeW.js";import"./BxkXgiy8.js";import"./dJIpU6wD.js";import"./CFNaZjOu.js";import"./BFNvVrx5.js";import"./CQhxZvjT.js";import"./DOPoUBoe.js";import"./DJApvAF_.js";(function(){try{var d=typeof window<"u"?window:typeof global<"u"?global:typeof globalThis<"u"?globalThis:typeof self<"u"?self:{};d.SENTRY_RELEASE={id:"cd189bad150b481aa5ecb2e95de26ec677010e55"}}catch{}})();try{(function(){var d=typeof window<"u"?window:typeof global<"u"?global:typeof globalThis<"u"?globalThis:typeof self<"u"?self:{},i=new d.Error().stack;i&&(d._sentryDebugIds=d._sentryDebugIds||{},d._sentryDebugIds[i]="103fab82-948e-428b-acbe-530709de9a8e",d._sentryDebugIdIdentifier="sentry-dbid-103fab82-948e-428b-acbe-530709de9a8e")})()}catch{}const Ee={class:"space-y-3"},Le={class:"flex justify-between items-center"},Ve={class:"text-xs text-gray-500"},Ae=W({__name:"RegisterISCN",emits:["handleSubmit","submit","formValidChange"],setup(d,{expose:i,emit:C}){const I=Q(),{wallet:R,signer:D}=X(I),{validateWalletConsistency:M}=I,{createNFTClass:m}=Re(),{stripHtmlTags:h,formatLanguage:s,getFileType:F}=xe(),{showErrorToast:N}=H(),p=n({type:"Book",title:"",description:"",alternativeHeadline:"",isbn:"",publisher:"",publicationDate:"",author:{name:"",description:""},license:"All Rights Reserved",customLicense:"",contentFingerprints:[{url:""}],downloadableUrls:[{url:"",type:"",fileName:""}],language:"",bookInfoUrl:"",tags:[],coverUrl:"",genre:""}),c=n(""),B=n(""),u=C,v=k(()=>Me(p.value)),S=k(()=>!v.value?.length);z(S,e=>{u("formValidChange",e)},{immediate:!0}),Z(()=>{const e=$();e&&(p.value=e)});const $=()=>{const e=ce();if(!e)return null;const r={type:"Book",title:e.epubMetadata?.title||"",description:h(e.epubMetadata?.description||""),isbn:"",publisher:"",publicationDate:new Date().toISOString().split("T")[0]||"",author:{name:e.epubMetadata?.author??"",description:""},license:"All Rights Reserved",customLicense:"",contentFingerprints:[],downloadableUrls:[],coverUrl:e.epubMetadata?.thumbnailArweaveId?`ar://${e.epubMetadata.thumbnailArweaveId}`:"",language:s(e.epubMetadata?.language||"zh"),bookInfoUrl:"",tags:e.epubMetadata?.tags||[],genre:""};return r.downloadableUrls=e.fileRecords.filter(t=>t.fileType==="application/pdf"||t.fileType==="application/epub+zip").map(t=>({url:t.arweaveKey?t.arweaveLink:`ar://${t.arweaveId}`,type:F(t.fileType),fileName:t.fileName})),r.contentFingerprints=[...new Set(e.fileRecords.map(t=>{const _=t.arweaveKey?t.arweaveLink:`ar://${t.arweaveId}`;return t.fileType==="application/epub+zip"||t.fileType==="application/pdf"?_:`ar://${t.arweaveId}`}).filter(Boolean))].map(t=>({url:t})),r},U=async()=>{if(c.value="checking",!S.value){N(v.value.join(", "));return}p.value.contentFingerprints.length&&await o()},o=async()=>{if(c.value="loading",await M(),!R.value||!D.value){B.value="MISSING_SIGNER",c.value="";return}try{c.value="signing";const{classId:e,txHash:r}=await m({iscnFormData:p});c.value="success",u("submit",{iscnId:e,txHash:r})}catch(e){console.error(e),N(`'SIGNING_ERROR':${e}`),c.value=""}finally{c.value=""}};return i({onSubmit:U}),(e,r)=>{const t=ke,_=de,E=fe,V=me;return b(),x("div",null,[y(t,{modelValue:l(p),"onUpdate:modelValue":r[0]||(r[0]=A=>ue(p)?p.value=A:null)},null,8,["modelValue"]),y(V,{open:!!l(c),dismissible:!1,class:"p-4 gap-2"},{body:O(()=>[g("div",Ee,[g("div",Le,[y(_,{variant:"soft"},{default:O(()=>[pe(j(l(c)),1)]),_:1}),g("p",Ve,j(e.$t("notifications.iscn_registration_complete")),1)]),y(E,{animation:"carousel",color:"primary",class:"w-full"})])]),_:1},8,["open"])])}}}),qe=Object.assign(_e(Ae,[["__scopeId","data-v-847c134f"]]),{__name:"RegisterISCN"}),ze={class:"flex flex-col items-stretch grow space-y-4"},Oe=3,je=W({__name:"MintNFT",props:{iscnId:{type:String,default:""}},emits:["submit","loadingChange"],setup(d,{expose:i,emit:C}){const{getClassOwner:I,getClassMetadata:R,checkNFTClassIsBookNFT:D}=Ue(),{showErrorToast:M}=H(),m=n(""),h=n(!1),s=n(""),F=n(null),N=n(""),p=n(null),c=C,B=k(()=>[{label:u("button.retry"),variant:"solid",color:"error",onClick:()=>window.location.reload()}]);z(h,o=>{c("loadingChange",o),o&&(m.value="")},{immediate:!0});const{t:u}=ee();te({title:()=>u("seo.mint_nft_book_title"),ogTitle:()=>u("seo.mint_nft_book_title")});const v=d;z(()=>v.iscnId,async o=>{o&&await S(v.iscnId)},{immediate:!0});async function S(o,e=0){if(o)try{if(h.value=!0,!await D(o))throw new Error("Invalid NFT Class ID");const[t,_]=await Promise.all([R(o),I(o)]);if(!t)throw new Error("Failed to fetch ISCN metadata");F.value={contentMetadata:t,owner:_,"@id":o},s.value=_,N.value=o,m.value="",h.value=!1}catch(r){if(e<Oe){const t=e+1,_=t*1e3;setTimeout(()=>{S(o,t)},_)}else m.value=u("error.fetch_classid_failed")+r,M(u("error.fetch_classid_failed")+r),h.value=!1}}function $(){p.value?.startNFTMintFlow()}function U({classId:o,nftMintCount:e}={}){N.value=o||"",c("submit",{classId:o||"",nftMintCount:e})}return i({startNFTMintFlow:$}),(o,e)=>{const r=ve,t=$e;return b(),x("div",ze,[l(m)?(b(),P(r,{key:0,icon:"i-heroicons-exclamation-triangle",color:"error",variant:"soft",title:`${l(m)}`,close:{icon:"i-heroicons-x-mark-20-solid",color:"error",variant:"link"},actions:l(B),onClose:e[0]||(e[0]=_=>m.value="")},null,8,["title","actions"])):G("",!0),y(t,{ref_key:"liteMintNFTRef",ref:p,"iscn-data":l(F)??void 0,"iscn-id":d.iscnId,"should-show-submit":!1,onSubmit:U},null,8,["iscn-data","iscn-id"])])}}}),Pe=Object.assign(je,{__name:"MintNFT"}),Ge={class:"w-full"},We={class:"justify-evenly items-center flex space-x-4 relative"},He={class:"text-sm font-semibold"},Ke={class:"mt-6 p-4 border rounded-lg bg-gray-100 text-center flex flex-col gap-[24px]"},Ye={key:0},Je={key:1},Qe={key:2},Xe={key:3},Ze={class:"flex gap-2 justify-center mt-4"},wt=W({__name:"new-book",setup(d){const{t:i}=ee(),C=Q(),{wallet:I,signer:R}=X(C),{validateWalletConsistency:D}=C,M=be(),m=ge(),{showErrorToast:h}=H(),s=n(0),F=n(),N=n(),p=n(),c=n(""),B=n(""),u=n(M.query.iscn_id?.toString()||""),v=n(M.query.class_id?.toString()||""),S=n([]),$=n(""),U=n(!1),o=n(!1);te({title:()=>i("seo_titles.publish_nft_book"),ogTitle:()=>i("seo_titles.publish_nft_book")});const e=k(()=>{switch(s.value){case 0:return i("publish_button.upload_files");case 1:return i("publish_button.metadata");case 2:return i("publish_button.mint_nft");default:return i("publish_button.publish_now")}}),r=k(()=>S.value?.length>0),t=k(()=>s.value===0?r.value:s.value<3),_=k(()=>s.value===0?$.value!=="":s.value===2?o.value:!1),E=[{title:i("publish_steps.upload_files"),description:"Upload your book file"},{title:i("publish_steps.register_iscn"),description:"Register ISCN"},{title:i("publish_steps.mint_nft"),description:"Mint NFT"},{title:i("publish_steps.new_book_publish"),description:"Publish new book"}];Z(()=>{let f=null;try{const a=sessionStorage.getItem(ye);a&&(f=JSON.parse(a))}catch(a){console.error(a)}u.value?(c.value=u.value,K({iscnId:u.value})):v.value?Y({classId:v.value}):f?.epubMetadata&&f?.fileRecords&&(B.value=f?.epubMetadata?.title)});const V=async()=>{if((!I.value||!R.value)&&await D(),!I.value||!R.value){h(i("auth.login_required"));return}try{if(s.value===0&&F.value){await F.value.onSubmit();return}if(s.value===1){if(!U.value){h("Please fill in all required fields");return}await N.value.onSubmit();return}if(s.value===2){await p.value.startNFTMintFlow();return}s.value<E.length-1&&s.value++}catch(f){console.error("Error during form submission:",f)}},A=f=>{const{fileRecords:a,epubMetadata:T}=f;T?.coverData&&(T.coverData=void 0),Ie({fileRecords:a,epubMetadata:T}),s.value=1},K=async f=>{const{iscnId:a}=f;a&&await q(m({query:{iscn_id:a}}),{replace:!0}),s.value=2,await J(),u.value=a},Y=async f=>{const{classId:a,nftMintCount:T}=f;a&&(v.value=a,await q(m({query:{class_id:a,count:T}}),{replace:!0}),s.value=3,await J())},ae=async()=>{Te(),await q(m({name:"my-books"}))};return(f,a)=>{const T=Fe,se=Ce,oe=qe,ne=Pe,ie=De,le=Se,re=Be;return b(),P(re,{class:"flex flex-col items-stretch grow space-y-4"},{default:O(()=>[g("div",Ge,[g("div",We,[a[4]||(a[4]=g("div",{class:"absolute w-full h-px bg-gray-300 top-[50%] left-0 z-[-1]"},null,-1)),(b(),x(he,null,we(E,(w,L)=>g("div",{key:L,class:"flex items-center space-x-2 bg-white p-2 rounded-lg"},[y(T,{size:L===l(s)?"lg":"md",text:(L+1).toString(),class:Ne(L===l(s)?"bg-primary-100":"bg-gray-200")},null,8,["size","text","class"]),g("p",He,j(w.title),1)])),64))]),g("div",Ke,[l(s)===0?(b(),x("div",Ye,[y(se,{ref_key:"uploadFormRef",ref:F,onFileUploadStatus:a[0]||(a[0]=w=>$.value=w),onFileReady:a[1]||(a[1]=w=>S.value=w),onSubmit:A},null,512)])):l(s)===1?(b(),x("div",Je,[y(oe,{ref_key:"registerISCN",ref:N,onFormValidChange:a[2]||(a[2]=w=>U.value=w),onSubmit:K},null,512)])):l(s)===2?(b(),x("div",Qe,[y(ne,{ref_key:"mintNFT",ref:p,"iscn-id":l(u),onLoadingChange:a[3]||(a[3]=w=>o.value=w),onSubmit:Y},null,8,["iscn-id"])])):l(s)===3?(b(),x("div",Xe,[y(ie,{ref:"newNFTBook",class:"p-0 flex flex-col text-left gap-[24px]","is-new-class-page":!0,"class-id":l(v),onSubmit:ae},null,8,["class-id"])])):G("",!0),g("div",Ze,[l(t)?(b(),P(le,{key:0,disabled:l(_),label:l(e),onClick:V},null,8,["disabled","label"])):G("",!0)])])])]),_:1})}}});export{wt as default};
