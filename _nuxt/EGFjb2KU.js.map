{"version":3,"file":"EGFjb2KU.js","sources":["../../../pages/latest-books.vue"],"sourcesContent":["<template>\n  <PageBody>\n    <PageHeader :title=\"$t('latest_books.title')\" />\n    <UAlert\n      v-if=\"error\"\n      icon=\"i-heroicons-exclamation-triangle\"\n      color=\"error\"\n      variant=\"soft\"\n      :title=\"`${error}`\"\n      :close=\"{ icon: 'i-heroicons-x-mark-20-solid', color: 'error', variant: 'link' }\"\n      @close=\"error = ''\"\n    />\n    <UAlert\n      v-if=\"!isAffiliationReady\"\n      icon=\"i-heroicons-exclamation-circle\"\n      color=\"warning\"\n      variant=\"soft\"\n      :title=\"$t('latest_books.join_affiliation')\"\n      :description=\"$t('latest_books.affiliation_description')\"\n      :actions=\"[{\n        label: $t('common.setup'),\n        color: 'warning',\n        variant: 'outline',\n        onClick: handleAffiliationSetupButtonClick,\n      }]\"\n    />\n    <UCard v-else>\n      {{ $t('latest_books_extended.append_text') }}<UKbd class=\"font-mono\">\n        ?from={{ channelId }}\n      </UKbd>{{ $t('latest_books_extended.append_suffix') }}\n    </UCard>\n    <UTabs v-model=\"selectedTabItemIndex\" class=\"w-full\" :items=\"tabItems\">\n      <template #content=\"{ item }\">\n        <UCard\n          :key=\"item.value\"\n          :ui=\"{\n            header: 'flex justify-between items-center',\n            body: 'p-0',\n            footer: 'text-center',\n          }\"\n        >\n          <div class=\"flex px-3 py-3.5 border-b border-gray-200\">\n            <UInput v-model=\"q\" :placeholder=\"$t('latest_books.filter_placeholder')\" />\n          </div>\n          <UTable :columns=\"tableColumns\" :data=\"filteredRows\" @select=\"selectTableRow\">\n            <template #image-cell=\"{ row }\">\n              <img v-if=\"row.original.image\" :src=\"row.original.image\" :alt=\"row.original.className\" class=\"w-12 h-12 object-cover rounded-lg\">\n            </template>\n            <template #className-cell=\"{ row }\">\n              <div class=\"max-w-[20vw] whitespace-normal\" v-text=\"row.original.className\" />\n            </template>\n            <template #url-cell=\"{ row }\">\n              <UButton :label=\"$t('common.copy')\" :disabled=\"!isAffiliationReady\" @click=\"handleCopyButtonClick($event, row.original.url)\" />\n            </template>\n          </UTable>\n        </UCard>\n      </template>\n    </UTabs>\n  </PageBody>\n</template>\n\n<script setup lang=\"ts\">\nimport type { BookRecord } from '~/types'\n\nconst { t: $t } = useI18n()\n\nconst { BOOK3_URL } = useRuntimeConfig().public\n\nconst userStore = useUserStore()\nconst stripeStore = useStripeStore()\nconst bookstoreApiStore = useBookstoreApiStore()\n\nconst localeRoute = useLocaleRoute()\nconst route = useRoute()\n\nconst { userLikerInfo } = storeToRefs(userStore)\nconst { isAuthenticated, wallet: sessionWallet } = storeToRefs(bookstoreApiStore)\n\nconst tabItems = computed(() => [\n  { label: $t('latest_books.latest_releases'), value: 'latest' },\n  { label: $t('latest_books.best_sellers'), value: 'bestselling' }\n])\n\nconst error = ref('')\nconst isStripeConnectReady = ref(false)\n\nconst latestBookList = ref<BookRecord[]>([])\nconst bestSellerBookList = ref<BookRecord[]>([])\nconst selectedTabItemIndex = ref('latest')\nconst q = ref(route.query.q as string || '')\n\nconst channelId = computed(() => {\n  if (userLikerInfo.value?.user) {\n    return convertLikerIdToChannelId(userLikerInfo.value?.user)\n  }\n  return ''\n})\n\nconst isAffiliationReady = computed(() => isStripeConnectReady.value && channelId.value)\n\nconst tableColumns = computed(() => [\n  {\n    accessorKey: 'image',\n    header: $t('table.cover')\n  },\n  {\n    accessorKey: 'className',\n    header: $t('latest_books.book_name')\n  },\n  {\n    accessorKey: 'author',\n    header: $t('common.author')\n  },\n  {\n    accessorKey: 'priceInUSD',\n    header: $t('common.price')\n  }, {\n    accessorKey: 'url',\n    header: isAffiliationReady.value ? $t('latest_books.affiliation_link') : $t('common.link')\n  }\n])\nconst selectedTabItemKey = computed(() => selectedTabItemIndex.value || 'latest')\nconst bookList = computed(() => selectedTabItemKey.value === 'latest' ? latestBookList.value : bestSellerBookList.value)\nconst tableRows = computed(() => bookList.value.map((b) => {\n  const className = b.name || b.title\n  const image = b.thumbnailUrl || b.imageUrl\n  const author = typeof b.author === 'object' ? b.author.name : b.author\n  return {\n    className,\n    image: image ? getImageResizeURL(parseImageURLFromMetadata(image)) : undefined,\n    author,\n    priceInUSD: `US$${b.minPrice || b.prices?.[0]?.price || 0}`,\n    url: `${BOOK3_URL}/store/${b.classId}?from=${channelId.value}&utm_source=bookpress&utm_medium=list_${selectedTabItemKey.value}`\n  }\n}))\n\nconst filteredRows = computed(() => {\n  if (!q.value) {\n    return tableRows.value\n  }\n  const query = q.value.toLowerCase()\n  return tableRows.value.filter((row) => {\n    return [row.className, row.author].some((value) => {\n      return value && value.toLowerCase().includes(query)\n    })\n  })\n})\n\nuseSeoMeta({\n  title: () => $t('seo.latest_books_title'),\n  ogTitle: () => $t('seo.latest_books_title')\n})\n\nonMounted(async () => {\n  await Promise.all([\n    fetchBookList().catch((e) => {\n      error.value = e\n    }),\n    fetchBestSellersList().catch((e) => {\n      error.value = e\n    })\n  ])\n  if (isAuthenticated.value) {\n    try {\n      await fetchUserStripeInfo()\n    } catch (e) {\n      console.error(e)\n    }\n  }\n})\n\nasync function fetchBookList () {\n  const data = await $fetch(`${BOOK3_URL}/api/store/products?tag=latest`)\n  latestBookList.value = (data as { records?: BookRecord[] })?.records || []\n}\n\nasync function fetchBestSellersList () {\n  const data = await $fetch(`${BOOK3_URL}/api/store/products?tag=bestselling`)\n  bestSellerBookList.value = (data as { records?: BookRecord[] })?.records || []\n}\n\nasync function fetchUserStripeInfo () {\n  if (!sessionWallet.value) {\n    isStripeConnectReady.value = false\n    return\n  }\n  try {\n    const stripeConnectStatus = await stripeStore.fetchStripeConnectStatusByWallet(sessionWallet.value)\n    isStripeConnectReady.value = stripeConnectStatus?.isReady\n  } catch (err) {\n    // eslint-disable-next-line no-console\n    console.error(err)\n    isStripeConnectReady.value = false\n  }\n}\n\nfunction handleAffiliationSetupButtonClick () {\n  useTrackEvent('latest_books_click_affiliation_setup')\n  navigateTo(localeRoute({ name: 'settings' }))\n}\n\nfunction selectTableRow (row: { original: { url: string } }) {\n  useTrackEvent('latest_books_click_table_row')\n  window.open(row.original.url, '_blank')\n}\n\nfunction handleCopyButtonClick (e: MouseEvent, text: string) {\n  e.stopPropagation()\n  useTrackEvent('latest_books_click_copy_button')\n  copyToClipboard(text)\n}\n\nwatch(isAuthenticated, () => {\n  if (isAuthenticated.value) {\n    nextTick(() => {\n      fetchUserStripeInfo()\n    })\n  }\n})\n\n</script>\n"],"names":["$t","useI18n","BOOK3_URL","useRuntimeConfig","userStore","useUserStore","stripeStore","useStripeStore","bookstoreApiStore","useBookstoreApiStore","localeRoute","useLocaleRoute","route","useRoute","userLikerInfo","storeToRefs","isAuthenticated","sessionWallet","tabItems","computed","error","ref","isStripeConnectReady","latestBookList","bestSellerBookList","selectedTabItemIndex","q","channelId","convertLikerIdToChannelId","isAffiliationReady","tableColumns","selectedTabItemKey","bookList","tableRows","b","className","image","author","getImageResizeURL","parseImageURLFromMetadata","filteredRows","query","row","value","useSeoMeta","onMounted","fetchBookList","fetchBestSellersList","fetchUserStripeInfo","data","stripeConnectStatus","err","handleAffiliationSetupButtonClick","useTrackEvent","navigateTo","selectTableRow","handleCopyButtonClick","text","copyToClipboard","watch","nextTick","_createBlock","_component_PageBody","_createVNode","_component_PageHeader","_unref","_component_UAlert","_component_UCard","_component_UKbd","_createTextVNode","_component_UTabs","$event","_withCtx","item","_createElementVNode","_hoisted_1","_component_UInput","_component_UTable","_createElementBlock","_toDisplayString","_component_UButton"],"mappings":"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"}