import{d as k,b as L,s as O,w as M,r as u,c as T,e as I,f as A}from"./9S2XGRg9.js";(function(){try{var t=typeof window<"u"?window:typeof global<"u"?global:typeof globalThis<"u"?globalThis:typeof self<"u"?self:{};t.SENTRY_RELEASE={id:"cd189bad150b481aa5ecb2e95de26ec677010e55"}}catch{}})();try{(function(){var t=typeof window<"u"?window:typeof global<"u"?global:typeof globalThis<"u"?globalThis:typeof self<"u"?self:{},c=new t.Error().stack;c&&(t._sentryDebugIds=t._sentryDebugIds||{},t._sentryDebugIds[c]="a145490c-f3c0-4920-8538-d0fddc9542a7",t._sentryDebugIdIdentifier="sentry-dbid-a145490c-f3c0-4920-8538-d0fddc9542a7")})()}catch{}const _=k("orders",()=>{const t=L(),{token:c,isAuthenticated:p}=O(t),d=I({}),o=I([]),m=I(!1),f=I("");M(p,()=>{p.value?b():B()});const C=T(()=>{const r=new Map;return o.value.forEach(a=>{const s=a.classId;r.has(s)||r.set(s,[]),r.get(s).push(a)}),r}),i=T(()=>{const r=Object.keys(d.value);if(r.length===0||o.value.length===0)return[];const a=new Map;return o.value.forEach(s=>{const n=s.email;if(!n)return;const e=new Date(s.timestamp).toISOString(),h=s.price||0,E=!!(s.message&&s.message.trim()),g=s.wallet;if(a.has(n)){const l=a.get(n);if(!l)return;new Date(e)<new Date(l.firstPurchaseTime)&&(l.firstPurchaseTime=e),new Date(e)>new Date(l.lastPurchaseTime)&&(l.lastPurchaseTime=e),l.lifetimeValue+=h,E&&(l.hasMessage=!0),l.purchasedBooks[s.classId]=!0,g&&!l.readerWallet&&(l.readerWallet=g)}else{const l={};r.forEach(S=>{l[S]=!1}),l[s.classId]=!0,a.set(n,{readerEmail:n,readerWallet:g,firstPurchaseTime:e,lastPurchaseTime:e,lifetimeValue:h,hasMessage:E,purchasedBooks:l})}}),Array.from(a.values()).map(s=>{const n={};return r.forEach(e=>{n[`book_${e}`]=s.purchasedBooks[e]?1:0}),{...s,...n}})});async function y(r){const a=[];for(const s of r)try{const e=(await A(s,c.value))?.orders||[];e.length>0&&a.push(...e.map(h=>({...h,classId:s})))}catch(n){console.error(`Failed to fetch orders for classId ${s}:`,n)}return o.value=a,a}async function w(r,a=!1){if(!a&&o.value.length>0){const s=new Set(o.value.map(e=>e.classId));if(r.every(e=>s.has(e)))return o.value}return await y(r)}async function v(r=!1){if(!(!r&&i.value.length>0))try{m.value=!0,f.value="",await t.fetchBookListing(),await t.fetchModeratedBookList();const a=[...t.listingList.map(e=>e.classId),...t.moderatedBookList.map(e=>e.classId)],s=[...new Set(a)];if(s.length===0){d.value={};return}const n={};t.listingList.forEach(e=>{s.includes(e.classId)&&(n[e.classId]={name:e.name||e.classId,classId:e.classId})}),t.moderatedBookList.forEach(e=>{s.includes(e.classId)&&(n[e.classId]={name:e.name||e.classId,classId:e.classId})}),d.value=n,await w(s,r)}catch(a){throw f.value=a.message||"Failed to load readers data",a}finally{m.value=!1}}async function b(){return i.value.length>0||await v(),i.value}function D(){f.value=""}function B(){o.value=[],d.value={}}return{readers:i,booksInfo:u(d),allOrders:u(o),ordersByClassIdMap:u(C),isLoading:u(m),error:u(f),fetchReaders:v,lazyFetchReaders:b,fetchOrdersByClassId:y,lazyFetchOrdersByClassId:w,clearError:D,clearCache:B}});export{_ as u};
